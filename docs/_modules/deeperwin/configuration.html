<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>deeperwin.configuration &mdash; deeperwin 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/autodoc_pydantic.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/custom_style.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../root.html" class="icon icon-home"> deeperwin
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">DeepErwin Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">Full documentation for developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../indices.html">Indices and tables</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../root.html">deeperwin</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../root.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>deeperwin.configuration</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for deeperwin.configuration</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">DeepErwin hyperparameter and configuration management.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">import</span> <span class="nn">ruamel.yaml.comments</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">validator</span><span class="p">,</span> <span class="n">root_validator</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pathlib</span>

<div class="viewcode-block" id="ConfigBaseclass"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.ConfigBaseclass">[docs]</a><span class="k">class</span> <span class="nc">ConfigBaseclass</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for all config models&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ConfigBaseclass.save"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.ConfigBaseclass.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">to_prettified_yaml</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">ruamel</span><span class="o">.</span><span class="n">yaml</span><span class="o">.</span><span class="n">YAML</span><span class="p">()</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ruamel</span><span class="o">.</span><span class="n">yaml</span><span class="o">.</span><span class="n">YAML</span><span class="p">()</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span></div>

<div class="viewcode-block" id="ConfigBaseclass.load"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.ConfigBaseclass.load">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;ConfigBaseclass&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">ruamel</span><span class="o">.</span><span class="n">yaml</span><span class="o">.</span><span class="n">YAML</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">ruamel</span><span class="o">.</span><span class="n">yaml</span><span class="o">.</span><span class="n">YAML</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">parse_obj</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="ConfigBaseclass.as_flattened_dict"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.ConfigBaseclass.as_flattened_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_flattened_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">output_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">():</span>
            <span class="n">subconfig</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">subconfig</span><span class="p">,</span> <span class="s1">&#39;as_flattened_dict&#39;</span><span class="p">):</span>
                <span class="n">subdict</span> <span class="o">=</span> <span class="n">subconfig</span><span class="o">.</span><span class="n">as_flattened_dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">sublabel</span><span class="p">,</span> <span class="n">subvalue</span> <span class="ow">in</span> <span class="n">subdict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">output_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">sublabel</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subvalue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">subconfig</span>
        <span class="k">return</span> <span class="n">output_dict</span></div>

<div class="viewcode-block" id="ConfigBaseclass.from_flattened_dict"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.ConfigBaseclass.from_flattened_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_flattened_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">,</span> <span class="n">ignore_extra_settings</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ignore_extra_settings</span><span class="p">:</span>
            <span class="k">class</span> <span class="nc">IgnoringConfig</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
                <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
                    <span class="n">extra</span> <span class="o">=</span> <span class="s2">&quot;ignore&quot;</span>
            <span class="n">nested_dict</span> <span class="o">=</span> <span class="n">IgnoringConfig</span><span class="o">.</span><span class="n">from_flattened_dict</span><span class="p">(</span><span class="n">config_dict</span><span class="p">)</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nested_dict</span> <span class="o">=</span> <span class="n">build_nested_dict</span><span class="p">(</span><span class="n">config_dict</span><span class="p">)</span>

        <span class="n">config</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span><span class="o">.</span><span class="n">parse_obj</span><span class="p">(</span><span class="n">nested_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config</span></div>

    <span class="nd">@root_validator</span><span class="p">(</span><span class="n">allow_reuse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">disable_unused_children</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">element</span><span class="p">],</span> <span class="s1">&#39;use&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">values</span><span class="p">[</span><span class="n">element</span><span class="p">]</span><span class="o">.</span><span class="n">use</span><span class="p">:</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">values</span>

<div class="viewcode-block" id="ConfigBaseclass.update_configdict_and_validate"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.ConfigBaseclass.update_configdict_and_validate">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">update_configdict_and_validate</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">config_changes</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]):</span>
        <span class="n">config_dict</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">config_dict</span><span class="p">)</span>
        <span class="c1"># First loop: Build an updated dictionary</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">config_changes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">set_with_flattened_key</span><span class="p">(</span><span class="n">config_dict</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="c1"># Parse the config dict and validate that all parameters are valid</span>
        <span class="n">parsed_config</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">parse_obj</span><span class="p">(</span><span class="n">config_dict</span><span class="p">)</span>

        <span class="c1"># Second loop: Update the values using the parsed values to get correct type; Not strictly necessary,</span>
        <span class="c1"># but yields nicer looking input-config files</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">config_changes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">set_with_flattened_key</span><span class="p">(</span><span class="n">config_dict</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">get_with_flattened_key</span><span class="p">(</span><span class="n">parsed_config</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">config_dict</span><span class="p">,</span> <span class="n">parsed_config</span></div>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The name &#39;Config&#39; here is a pydantic term used to config the behaviour of the dataclass.</span>
<span class="sd">        It&#39;s not a config for the variational monte carlo code&quot;&quot;&quot;</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="s2">&quot;forbid&quot;</span></div>


<div class="viewcode-block" id="InitializationConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.InitializationConfig">[docs]</a><span class="k">class</span> <span class="nc">InitializationConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">bias_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">weight_scale</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;glorot&quot;</span><span class="p">,</span> <span class="s2">&quot;glorot-input&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;glorot&quot;</span>

    <span class="n">weight_distribution</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="s2">&quot;uniform&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;uniform&quot;</span></div>


<div class="viewcode-block" id="EmbeddingConfigFermiNet"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.EmbeddingConfigFermiNet">[docs]</a><span class="k">class</span> <span class="nc">EmbeddingConfigFermiNet</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;ferminet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ferminet&quot;</span>

    <span class="n">n_hidden_one_el</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">256</span>
    <span class="sd">&quot;&quot;&quot;Number of hidden neurons per layer for the one electron stream in the FermiNet network&quot;&quot;&quot;</span>

    <span class="n">n_hidden_two_el</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="sd">&quot;&quot;&quot;Number of hidden neurons per layer for the electron-electron stream in the FermiNet network&quot;&quot;&quot;</span>

    <span class="n">n_hidden_el_ions</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="sd">&quot;&quot;&quot;Number of hidden neurons per layer for the electron-ion stream in the FermiNet network&quot;&quot;&quot;</span>

    <span class="n">n_iterations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="sd">&quot;&quot;&quot;Number iterations to combine features of different particle streams into the one electron stream&quot;&quot;&quot;</span>

    <span class="n">use_el_ion_stream</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;Whether to generate a second stream of interactions between electrons and ions&quot;&quot;&quot;</span>

    <span class="n">use_average_h_one</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;Whether to include the average embedding of all electrons as a feature into the 1-el-stream&quot;&quot;&quot;</span>

    <span class="n">initialization</span><span class="p">:</span> <span class="n">InitializationConfig</span> <span class="o">=</span> <span class="n">InitializationConfig</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;How to initialize weights and biases&quot;&quot;&quot;</span>

    <span class="n">use_average_h_two</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;Use the average over the electron-electron stream output as additional feature for the one electron stream&quot;&quot;&quot;</span>

    <span class="n">use_h_one</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;Use the electron stream output as features for its own stream in the next iteration&quot;&quot;&quot;</span>

    <span class="n">use_h_two_same_diff</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;Split the electron-electron stream into same- and different spin channel. Effectively turning one stream into two</span>
<span class="sd">    seperate streams&quot;&quot;&quot;</span>

    <span class="n">use_schnet_features</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;Use SchNet convolution features as input to the one electron stream&quot;&quot;&quot;</span>

    <span class="n">sum_schnet_features</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;Sum electron-electron and electron-ion SchNet convolution features together&quot;&quot;&quot;</span>

    <span class="n">emb_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span>
    <span class="sd">&quot;&quot;&quot;Embedding dimension for the electron-electron and electron-ion SchNet convolution features&quot;&quot;&quot;</span>

    <span class="n">use_linear_out</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;Use linear layer for mapping particle features to same dimension&quot;&quot;&quot;</span>

    <span class="n">use_w_mapping</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;Apply neural network for inter-particle features to further process before computing SchNet convolution&quot;&quot;&quot;</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;n_iterations&quot;</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_set_n_iterations</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;n_hidden_one_el&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n_hidden_one_el must be a list of net-widths if n_iterations is not specified&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">n</span>

    <span class="nd">@root_validator</span>
    <span class="k">def</span> <span class="nf">_set_n_hidden</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_make_list</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">len</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span>
        <span class="n">_make_list</span><span class="p">(</span><span class="s1">&#39;n_hidden_one_el&#39;</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;n_iterations&#39;</span><span class="p">])</span>
        <span class="n">_make_list</span><span class="p">(</span><span class="s1">&#39;n_hidden_two_el&#39;</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;n_iterations&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">_make_list</span><span class="p">(</span><span class="s1">&#39;n_hidden_el_ions&#39;</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;n_iterations&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;n_hidden_one_el&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;n_hidden_two_el&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of layers for 1-el-stream must be one more than nr of layers in 2-el-stream&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span></div>


<div class="viewcode-block" id="EmbeddingConfigDeepErwin4"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.EmbeddingConfigDeepErwin4">[docs]</a><span class="k">class</span> <span class="nc">EmbeddingConfigDeepErwin4</span><span class="p">(</span><span class="n">EmbeddingConfigFermiNet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;DO NOT INTRODUCE NEW FIELDS HERE. This class is only used to provide alternative defaults&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;dpe4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;dpe4&quot;</span>
    <span class="n">n_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">n_hidden_one_el</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">256</span>
    <span class="n">n_hidden_two_el</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">n_hidden_el_ions</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">use_el_ion_stream</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">use_h_two_same_diff</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">emb_dim</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">use_w_mapping</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">use_schnet_features</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">sum_schnet_features</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">use_average_h_one</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">use_average_h_two</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">use_h_one</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">use_linear_out</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="EmbeddingConfigDeepErwin1"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.EmbeddingConfigDeepErwin1">[docs]</a><span class="k">class</span> <span class="nc">EmbeddingConfigDeepErwin1</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;dpe1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;dpe1&quot;</span>
    <span class="sd">&quot;&quot;&quot;Identifier for this model-part. Fixed.&quot;&quot;&quot;</span>

    <span class="n">embedding_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span>
    <span class="sd">&quot;&quot;&quot;Dimensionality of embedding vectors, including intermediate network widths.&quot;&quot;&quot;</span>

    <span class="n">n_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="sd">&quot;&quot;&quot;Number of embedding iterations for SchNet&quot;&quot;&quot;</span>

    <span class="n">n_hidden_w</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Number of hidden neurons per layer of the w-Network within SchNet. The w-network takes pairwise features between particles as inputs and calculates the weight of each embedding dimension as output. If not specified the width/depth as specified in net_width/net_depth is used&quot;&quot;&quot;</span>

    <span class="n">deep_w</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;Whether to process inter-particle features further or to use for every SchNet iteration the inter-particle distances&quot;&quot;&quot;</span>

    <span class="n">n_hidden_h</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Number of hidden neurons per layer of the h-Network within SchNet. The h-network takes the embedding of the previous iteration as input and computes a new embedding per particle, which is then weighted using the w-networks. If not specified the width/depth as specified in net_width/net_depth is used&quot;&quot;&quot;</span>

    <span class="n">n_hidden_g</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">40</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Number of hidden neurons per layer of the g-Network within SchNet. The g-network applies a final non-linear transformation at the end of each SchNet round. If not specified the width as specified in net_width and depth = net_depth - 1 is used&quot;&quot;&quot;</span>

    <span class="n">use_linear_layer_w</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">use_res_net</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;Whether to use residuals for the networks&quot;&quot;&quot;</span>

    <span class="n">one_el_input</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="CuspCorrectionConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.CuspCorrectionConfig">[docs]</a><span class="k">class</span> <span class="nc">CuspCorrectionConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">use</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">cusp_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;mo&quot;</span><span class="p">,</span> <span class="s2">&quot;ao&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mo&quot;</span>
    <span class="sd">&quot;&quot;&quot;Mode how to calculate cusp-corrected orbitals. </span>
<span class="sd">    &#39;ao&#39; computes a cusp correction for each atomic orbital (i.e. for each basis function), </span>
<span class="sd">    &#39;mo&#39; computes a cusp correction for each molecular orbital (i.e. each solution of the HF-calculation).</span>
<span class="sd">    For atoms both cusp_types should be equivalent, but for molecules the simpler &#39;ao&#39; cusps can in principle not correctly model the cusps that arise from an atomic wavefunction having a finite contribution at a different nucleus.   </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">r_cusp_el_ion_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="sd">&quot;&quot;&quot;Scaling parameter for the electron-ion cusp corrections. No cusp correction is applied outside a radius :code:`r_cusp_el_ion_scale / Z`&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="CASSCFConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.CASSCFConfig">[docs]</a><span class="k">class</span> <span class="nc">CASSCFConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;casscf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;casscf&quot;</span>
    <span class="sd">&quot;&quot;&quot;Identifier of the baseline calculation. Fixed.&quot;&quot;&quot;</span>

    <span class="n">basis_set</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;6-311G&quot;</span>
    <span class="sd">&quot;&quot;&quot;Basis set to use for the Hartree-Fock / CASSCF calculation. See the documentation of pySCF for all available basis-sets.&quot;&quot;&quot;</span>

    <span class="n">cusps</span><span class="p">:</span> <span class="n">CuspCorrectionConfig</span> <span class="o">=</span> <span class="n">CuspCorrectionConfig</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Settings for the correction of wavefunction cusps when particles come close to each other&quot;&quot;&quot;</span>

    <span class="n">only_hf</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;Only as HF orbitals as baseline method&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="InputFeatureConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.InputFeatureConfig">[docs]</a><span class="k">class</span> <span class="nc">InputFeatureConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">use_rbf_features</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="sd">&quot;&quot;&quot;Whether to build distance features using gaussian functions of the distances&quot;&quot;&quot;</span>

    <span class="n">n_rbf_features</span><span class="p">:</span> <span class="nb">int</span>
    <span class="sd">&quot;&quot;&quot;Number of radial basis functions to use as pairwise fature vector&quot;&quot;&quot;</span>

    <span class="n">use_distance_features</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="sd">&quot;&quot;&quot;Whether to include the absolute value of the distance (and powers of this distance) as input feature&quot;&quot;&quot;</span>

    <span class="n">use_el_ion_differences</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="sd">&quot;&quot;&quot;Whether to include electron-ion differences as input features&quot;&quot;&quot;</span>

    <span class="n">use_el_el_differences</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="sd">&quot;&quot;&quot;Whether to include electron-electron differences as input features&quot;&quot;&quot;</span>

    <span class="n">use_el_el_spin</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="sd">&quot;&quot;&quot;Whether to include additional information about the spin configurations of the elctrons&quot;&quot;&quot;</span>

    <span class="n">use_local_coordinates</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="sd">&quot;&quot;&quot;Whether to construct local coordinate systems by diagonalizing the density matrix, leading to equivariant difference featres&quot;&quot;&quot;</span>

    <span class="n">n_one_el_features</span><span class="p">:</span> <span class="nb">int</span>
    <span class="sd">&quot;&quot;&quot;Generate one-electron features as a sum of el-ion features&quot;&quot;&quot;</span>

    <span class="n">n_ion_features</span><span class="p">:</span> <span class="nb">int</span>
    <span class="sd">&quot;&quot;&quot;Embed nuclear charges into vectors of length n_ion_faetures&quot;&quot;&quot;</span>

    <span class="n">concatenate_el_ion_features</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="sd">&quot;&quot;&quot;Whether to use concatenated electron-ion features as initialization for h_one; breaks equivariance&quot;&quot;&quot;</span>

    <span class="n">n_hidden_one_el_features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Number of hidden nodes for generation of one-electron-features from el-ion-features&quot;&quot;&quot;</span>

    <span class="n">eps_dist_feat</span><span class="p">:</span> <span class="nb">float</span>
    <span class="sd">&quot;&quot;&quot;Epsilon to be used when calculating pairwise features with negative exponent n &lt; 0. Feature vector is calculated as :math:`\\frac{1}{dist^{-n} + eps}`&quot;&quot;&quot;</span>

    <span class="n">distance_feature_powers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;To calculate the embeddings, pairwise distances between particles are converted into input feature vectors and then fed into the embedding network. </span>
<span class="sd">    These input feature vectors partially consist of radial-basis-functions and monomials of the distance (i.e. r^n). This list specifies which exponents should be used to create the distance monomials.</span>
<span class="sd">    Note, that using powers of -1 or +1 can lead to cusps in the input features, which may or may not be desirable.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="InputFeatureConfigDPE1"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.InputFeatureConfigDPE1">[docs]</a><span class="k">class</span> <span class="nc">InputFeatureConfigDPE1</span><span class="p">(</span><span class="n">InputFeatureConfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;DO NOT INTRODUCE NEW FIELDS HERE. This class is only used to provide alternative defaults&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;dpe1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;dpe1&quot;</span>
    <span class="n">use_rbf_features</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">n_rbf_features</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">use_distance_features</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">distance_feature_powers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">eps_dist_feat</span><span class="p">:</span><span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-2</span>
    <span class="n">use_el_ion_differences</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">use_el_el_differences</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">n_one_el_features</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_hidden_one_el_features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">concatenate_el_ion_features</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">use_el_el_spin</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">use_local_coordinates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">n_ion_features</span> <span class="o">=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="InputFeatureConfigFermiNet"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.InputFeatureConfigFermiNet">[docs]</a><span class="k">class</span> <span class="nc">InputFeatureConfigFermiNet</span><span class="p">(</span><span class="n">InputFeatureConfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;DO NOT INTRODUCE NEW FIELDS HERE. This class is only used to provide alternative defaults&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;ferminet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ferminet&quot;</span>
    <span class="n">use_rbf_features</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">n_rbf_features</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">use_distance_features</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">eps_dist_feat</span><span class="p">:</span><span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-2</span>
    <span class="n">distance_feature_powers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">use_el_ion_differences</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">use_el_el_differences</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">n_one_el_features</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_hidden_one_el_features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">concatenate_el_ion_features</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">use_el_el_spin</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">use_local_coordinates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">n_ion_features</span> <span class="o">=</span> <span class="mi">32</span></div>

<div class="viewcode-block" id="InputFeatureConfigDPE4"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.InputFeatureConfigDPE4">[docs]</a><span class="k">class</span> <span class="nc">InputFeatureConfigDPE4</span><span class="p">(</span><span class="n">InputFeatureConfigFermiNet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;DO NOT INTRODUCE NEW FIELDS HERE. This class is only used to provide alternative defaults&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;dpe4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;dpe4&quot;</span>
    <span class="n">use_local_coordinates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">use_el_el_differences</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="EnvelopeOrbitalsConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.EnvelopeOrbitalsConfig">[docs]</a><span class="k">class</span> <span class="nc">EnvelopeOrbitalsConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">envelope_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;isotropic_exp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;isotropic_exp&quot;</span>
    <span class="sd">&quot;&quot;&quot;Which enveolope to use for the backflow-add term&quot;&quot;&quot;</span>

    <span class="n">n_hidden</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="sd">&quot;&quot;&quot;List of ints, specifying the number of hidden units per layer in the backflow-factor-network.&quot;&quot;&quot;</span>

    <span class="n">use_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;Enable / disable bias terms for the final layer of the backflow-add network&quot;&quot;&quot;</span>

    <span class="n">initialization</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="s2">&quot;analytical&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;constant&quot;</span>
    <span class="sd">&quot;&quot;&quot;Use a least-squares fit to initialized the scale- and decay-parameters for the envelopes instead of constant intialization&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="BaselineOrbitalsConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.BaselineOrbitalsConfig">[docs]</a><span class="k">class</span> <span class="nc">BaselineOrbitalsConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">baseline</span><span class="p">:</span> <span class="n">CASSCFConfig</span> <span class="o">=</span> <span class="n">CASSCFConfig</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Config-options for the underlying baseline calculation, typically a Complete-Active-Space Self-Consistent-Field (CASSCF) Calculation&quot;&quot;&quot;</span>

    <span class="n">use_trainable_scales</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;Scale the network outputs by a trainable float. Clever initialization of this scale can speed-up training, but in principle also introduces redundant parameters.&quot;&quot;&quot;</span>

    <span class="n">use_bf_shift</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;Enable the backflow-shift, i.e. shift all electron coordinates by a neural network before calculating the CASSCF orbitals&quot;&quot;&quot;</span>

    <span class="n">use_trainable_shift_decay_radius</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;Backflow-shift decays to 0 close the the nuclei to ensure correct cusp conditions. This flag specifies whether the radius in which the shift decays is a trainable parameter or fixed.&quot;&quot;&quot;</span>

    <span class="n">register_scale</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;Whether to register the parameterst that scale the output of the backflow networks as parameters for KFAC optimization&quot;&quot;&quot;</span>

    <span class="n">n_hidden_bf_factor</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;List of ints, specifying the number of hidden units per layer in the backflow-factor-network. If not provided, the width and depth set by *net_width* and *net_depth* are used.&quot;&quot;&quot;</span>

    <span class="n">n_hidden_bf_shift</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;List of ints, specifying the number of hidden units per layer in the backflow-shift-network. If not provided, the width and depth set by *net_width* and *net_depth* are used.&quot;&quot;&quot;</span>

    <span class="n">use_bf_factor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;Enable the backflow-factor, i.e. multiply the CASSCF orbitals with the output of a neural network&quot;&quot;&quot;</span>

    <span class="n">use_bf_factor_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;Enable / disable bias terms for the final layer of the backflow-factor network&quot;&quot;&quot;</span>

    <span class="n">bf_factor_constant_bias</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="sd">&quot;&quot;&quot;Bias to apply to the output of the backflow factor, i.e. phi = phi_HF x (backflow + bias). If bias is set to 1.0, NN-output of zero, yields to original HF-orbitals&quot;&quot;&quot;</span>

    <span class="n">output_shift</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="sd">&quot;&quot;&quot;Dimensionality of the output for the backflow-shift network. Can either be scalar or 3-dimensional. Note that only a scalar output ensures rotational equivariance.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="OrbitalsConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.OrbitalsConfig">[docs]</a><span class="k">class</span> <span class="nc">OrbitalsConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">baseline_orbitals</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaselineOrbitalsConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Orbitals containing a baked-in baselin model (e.g. Hartree-Fock or CASSCF) which gets modified by 2 neural networks: backflow shifts and backflow factors&quot;&quot;&quot;</span>

    <span class="n">envelope_orbitals</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EnvelopeOrbitalsConfig</span><span class="p">]</span> <span class="o">=</span> <span class="n">EnvelopeOrbitalsConfig</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Obritals containing only a simple, parametrized envelope, multiplied by a neural network&quot;&quot;&quot;</span>

    <span class="n">n_determinants</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="sd">&quot;&quot;&quot;Number of determinants in the wavefunction model&quot;&quot;&quot;</span>

    <span class="n">use_full_det</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;Whether to use full n_el x n_el determinants, or whether to assume a block diagonal structure, </span>
<span class="sd">    represented by det(n_up x n_up)*det(n_dn x n_dn)&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="OrbitalsConfigFermiNet"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.OrbitalsConfigFermiNet">[docs]</a><span class="k">class</span> <span class="nc">OrbitalsConfigFermiNet</span><span class="p">(</span><span class="n">OrbitalsConfig</span><span class="p">):</span>
    <span class="n">baseline_orbitals</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaselineOrbitalsConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">envelope_orbitals</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EnvelopeOrbitalsConfig</span><span class="p">]</span> <span class="o">=</span> <span class="n">EnvelopeOrbitalsConfig</span><span class="p">()</span>
    <span class="n">n_determinants</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">use_full_det</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="OrbitalsConfigDPE1"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.OrbitalsConfigDPE1">[docs]</a><span class="k">class</span> <span class="nc">OrbitalsConfigDPE1</span><span class="p">(</span><span class="n">OrbitalsConfig</span><span class="p">):</span>
    <span class="n">baseline_orbitals</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaselineOrbitalsConfig</span><span class="p">]</span> <span class="o">=</span> <span class="n">BaselineOrbitalsConfig</span><span class="p">()</span>
    <span class="n">envelope_orbitals</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EnvelopeOrbitalsConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">n_determinants</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">use_full_det</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="JastrowConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.JastrowConfig">[docs]</a><span class="k">class</span> <span class="nc">JastrowConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">use</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">n_hidden</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;List of ints, specifying the number of hidden units per layer in the jastrow-network. If not provided, the width and depth set by *net_width* and *net_depth* are used.&quot;&quot;&quot;</span>

    <span class="n">differentiate_spins</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;Use separate functions for J(spin_up) and J(spin_down)&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="MLPConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.MLPConfig">[docs]</a><span class="k">class</span> <span class="nc">MLPConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">activation</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;tanh&quot;</span><span class="p">,</span> <span class="s2">&quot;silu&quot;</span><span class="p">,</span> <span class="s2">&quot;elu&quot;</span><span class="p">,</span> <span class="s2">&quot;relu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;tanh&quot;</span>

    <span class="n">init_bias_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">init_weights_scale</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;fan_in&quot;</span><span class="p">,</span> <span class="s2">&quot;fan_out&quot;</span><span class="p">,</span> <span class="s2">&quot;fan_avg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;fan_avg&quot;</span>

    <span class="n">init_weights_distribution</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="s2">&quot;truncated_normal&quot;</span><span class="p">,</span> <span class="s2">&quot;uniform&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;uniform&quot;</span></div>


<div class="viewcode-block" id="ModelConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.ModelConfig">[docs]</a><span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Configuration for the primary wavefunction model, which maps electron coordinate to psi&quot;&quot;&quot;</span>

    <span class="n">features</span><span class="p">:</span> <span class="n">InputFeatureConfig</span>
    <span class="sd">&quot;&quot;&quot;Config-options for mapping raw inputs (r,R,Z) to some symmetrized input features&quot;&quot;&quot;</span>

    <span class="n">embedding</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EmbeddingConfigDeepErwin4</span><span class="p">,</span> <span class="n">EmbeddingConfigFermiNet</span><span class="p">,</span> <span class="n">EmbeddingConfigDeepErwin1</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Config-options for mapping symmetrized input features to high-dimensional embeddings of electrons&quot;&quot;&quot;</span>

    <span class="n">orbitals</span><span class="p">:</span> <span class="n">OrbitalsConfig</span>
    <span class="sd">&quot;&quot;&quot;Config-options for computing orbitals from embedding vectors of electrons&quot;&quot;&quot;</span>

    <span class="n">mlp</span><span class="p">:</span> <span class="n">MLPConfig</span> <span class="o">=</span> <span class="n">MLPConfig</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;How to build multi-layer-perceptrons: Activation and how to initialize weights and biases&quot;&quot;&quot;</span>

    <span class="n">jastrow</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">JastrowConfig</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Enable the jastrow-factor, i.e. multiple the total wavefunction by the output of a global neural network&quot;&quot;&quot;</span>

    <span class="n">use_el_el_cusp_correction</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="sd">&quot;&quot;&quot;Explicit, additive el-el-cusp correction&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="ModelConfigDeepErwin1"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.ModelConfigDeepErwin1">[docs]</a><span class="k">class</span> <span class="nc">ModelConfigDeepErwin1</span><span class="p">(</span><span class="n">ModelConfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;DO NOT INTRODUCE NEW FIELDS HERE. This class is only used to provide alternative defaults&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;dpe1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;dpe1&quot;</span>
    <span class="n">features</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">InputFeatureConfigDPE1</span><span class="p">,</span> <span class="n">InputFeatureConfigFermiNet</span><span class="p">]</span> <span class="o">=</span> <span class="n">InputFeatureConfigDPE1</span><span class="p">()</span>
    <span class="n">embedding</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EmbeddingConfigDeepErwin1</span><span class="p">,</span> <span class="n">EmbeddingConfigDeepErwin4</span><span class="p">,</span> <span class="n">EmbeddingConfigFermiNet</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">EmbeddingConfigDeepErwin1</span><span class="p">()</span>
    <span class="n">orbitals</span><span class="p">:</span> <span class="n">OrbitalsConfigDPE1</span> <span class="o">=</span> <span class="n">OrbitalsConfigDPE1</span><span class="p">()</span>
    <span class="n">jastrow</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">JastrowConfig</span><span class="p">]</span> <span class="o">=</span> <span class="n">JastrowConfig</span><span class="p">()</span>
    <span class="n">use_el_el_cusp_correction</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="ModelConfigDeepErwin4"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.ModelConfigDeepErwin4">[docs]</a><span class="k">class</span> <span class="nc">ModelConfigDeepErwin4</span><span class="p">(</span><span class="n">ModelConfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;DO NOT INTRODUCE NEW FIELDS HERE. This class is only used to provide alternative defaults&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;dpe4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;dpe4&quot;</span>
    <span class="n">features</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">InputFeatureConfigDPE4</span><span class="p">,</span> <span class="n">InputFeatureConfigFermiNet</span><span class="p">,</span> <span class="n">InputFeatureConfigDPE1</span><span class="p">]</span> <span class="o">=</span> <span class="n">InputFeatureConfigDPE4</span><span class="p">()</span>
    <span class="n">embedding</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EmbeddingConfigDeepErwin4</span><span class="p">,</span> <span class="n">EmbeddingConfigFermiNet</span><span class="p">,</span> <span class="n">EmbeddingConfigDeepErwin1</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">EmbeddingConfigDeepErwin4</span><span class="p">()</span>
    <span class="n">orbitals</span><span class="p">:</span> <span class="n">OrbitalsConfigFermiNet</span> <span class="o">=</span> <span class="n">OrbitalsConfigFermiNet</span><span class="p">()</span>
    <span class="n">jastrow</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">JastrowConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">use_el_el_cusp_correction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="ModelConfigFermiNet"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.ModelConfigFermiNet">[docs]</a><span class="k">class</span> <span class="nc">ModelConfigFermiNet</span><span class="p">(</span><span class="n">ModelConfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;DO NOT INTRODUCE NEW FIELDS HERE. This class is only used to provide alternative defaults&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;ferminet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ferminet&quot;</span>
    <span class="n">features</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">InputFeatureConfigFermiNet</span><span class="p">,</span> <span class="n">InputFeatureConfigDPE1</span><span class="p">]</span> <span class="o">=</span> <span class="n">InputFeatureConfigFermiNet</span><span class="p">()</span>
    <span class="n">embedding</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EmbeddingConfigFermiNet</span><span class="p">,</span> <span class="n">EmbeddingConfigDeepErwin4</span><span class="p">,</span> <span class="n">EmbeddingConfigDeepErwin1</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">EmbeddingConfigFermiNet</span><span class="p">()</span>
    <span class="n">orbitals</span><span class="p">:</span> <span class="n">OrbitalsConfigFermiNet</span> <span class="o">=</span> <span class="n">OrbitalsConfigFermiNet</span><span class="p">()</span>
    <span class="n">jastrow</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">JastrowConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">use_el_el_cusp_correction</span> <span class="o">=</span> <span class="kc">False</span></div>

<span class="n">EmbeddingConfigType</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">EmbeddingConfigDeepErwin4</span><span class="p">,</span> <span class="n">EmbeddingConfigFermiNet</span><span class="p">,</span> <span class="n">EmbeddingConfigDeepErwin1</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>

<div class="viewcode-block" id="MCMCSimpleProposalConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.MCMCSimpleProposalConfig">[docs]</a><span class="k">class</span> <span class="nc">MCMCSimpleProposalConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="s2">&quot;cauchy&quot;</span><span class="p">,</span> <span class="s2">&quot;normal_one_el&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;normal&quot;</span></div>

<div class="viewcode-block" id="MCMCLangevinProposalConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.MCMCLangevinProposalConfig">[docs]</a><span class="k">class</span> <span class="nc">MCMCLangevinProposalConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;langevin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;langevin&quot;</span>

    <span class="n">langevin_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">r_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span>

    <span class="n">r_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span></div>


<div class="viewcode-block" id="LocalStepsizeProposalConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.LocalStepsizeProposalConfig">[docs]</a><span class="k">class</span> <span class="nc">LocalStepsizeProposalConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Config for a local stepsize proposal rule for MCMC. Stepsize depends on distance to closest nuclei&quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="s2">&quot;local_one_el&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;local&quot;</span>

    <span class="n">r_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="sd">&quot;&quot;&quot;Minimal stepsize for electron move&quot;&quot;&quot;</span>

    <span class="n">r_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="sd">&quot;&quot;&quot;Max stepsize for electron move&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="MCMCConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.MCMCConfig">[docs]</a><span class="k">class</span> <span class="nc">MCMCConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Config for Markov-Chain-Monte-Carlo integration&quot;&quot;&quot;</span>

    <span class="n">n_inter_steps</span><span class="p">:</span> <span class="nb">int</span>
    <span class="sd">&quot;&quot;&quot;Number of MCMC steps between epochs&quot;&quot;&quot;</span>

    <span class="n">n_burn_in</span><span class="p">:</span> <span class="nb">int</span>
    <span class="sd">&quot;&quot;&quot;Number of MCMC steps before starting optimization&quot;&quot;&quot;</span>

    <span class="n">max_age</span><span class="p">:</span> <span class="nb">int</span>
    <span class="sd">&quot;&quot;&quot;Maximum number of MCMC steps for which a walker can reject updates during optimization. After having rejected an update max_age times, the walkers is forced to accepet, to avoid getting stuck&quot;&quot;&quot;</span>

    <span class="n">stepsize_update_interval</span><span class="p">:</span> <span class="nb">int</span>
    <span class="sd">&quot;&quot;&quot;Number of steps after which the step-size is adjusted&quot;&quot;&quot;</span>

    <span class="n">n_walkers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2048</span>
    <span class="sd">&quot;&quot;&quot;Number of walkers for optimization&quot;&quot;&quot;</span>

    <span class="n">target_acceptance_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="sd">&quot;&quot;&quot;Acceptance-rate that the MCMC-runner is trying to achieve by modifying the stepsize&quot;&quot;&quot;</span>

    <span class="n">min_stepsize_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-2</span>
    <span class="sd">&quot;&quot;&quot;Minimum stepsize. For spatially adaptive stepsize-schemes this only defines a factor which may be modified by the adaptive scheme&quot;&quot;&quot;</span>


    <span class="n">max_stepsize_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="sd">&quot;&quot;&quot;Maximum stepsize. For spatially adaptive stepsize-schemes this only defines a factor which may be modified by the adaptive scheme&quot;&quot;&quot;</span>

    <span class="n">proposal</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">MCMCSimpleProposalConfig</span><span class="p">,</span> <span class="n">LocalStepsizeProposalConfig</span><span class="p">,</span> <span class="n">MCMCLangevinProposalConfig</span><span class="p">]</span> <span class="o">=</span> <span class="n">MCMCSimpleProposalConfig</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Type of proposal function to use for MCMC steps&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="MCMCConfigPreTrain"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.MCMCConfigPreTrain">[docs]</a><span class="k">class</span> <span class="nc">MCMCConfigPreTrain</span><span class="p">(</span><span class="n">MCMCConfig</span><span class="p">):</span>
    <span class="n">n_inter_steps</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">n_burn_in</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">stepsize_update_interval</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">max_age</span> <span class="o">=</span> <span class="mi">20</span></div>

<div class="viewcode-block" id="MCMCConfigOptimization"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.MCMCConfigOptimization">[docs]</a><span class="k">class</span> <span class="nc">MCMCConfigOptimization</span><span class="p">(</span><span class="n">MCMCConfig</span><span class="p">):</span>
    <span class="n">n_inter_steps</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">n_burn_in</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">stepsize_update_interval</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">max_age</span> <span class="o">=</span> <span class="mi">20</span></div>

<div class="viewcode-block" id="MCMCConfigEvaluation"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.MCMCConfigEvaluation">[docs]</a><span class="k">class</span> <span class="nc">MCMCConfigEvaluation</span><span class="p">(</span><span class="n">MCMCConfig</span><span class="p">):</span>
    <span class="n">n_inter_steps</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">n_burn_in</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">stepsize_update_interval</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">max_age</span> <span class="o">=</span> <span class="mi">100</span></div>


<div class="viewcode-block" id="ClippingConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.ClippingConfig">[docs]</a><span class="k">class</span> <span class="nc">ClippingConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;hard&quot;</span><span class="p">,</span> <span class="s2">&quot;tanh&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;tanh&quot;</span>
    <span class="n">width_metric</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="s2">&quot;mae&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;std&quot;</span>
    <span class="n">center</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span>
    <span class="n">from_previous_step</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">clip_by</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span></div>


<div class="viewcode-block" id="ConstantLRSchedule"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.ConstantLRSchedule">[docs]</a><span class="k">class</span> <span class="nc">ConstantLRSchedule</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;fixed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;fixed&quot;</span></div>


<div class="viewcode-block" id="InverseLRScheduleConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.InverseLRScheduleConfig">[docs]</a><span class="k">class</span> <span class="nc">InverseLRScheduleConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;inverse&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;inverse&quot;</span>
    <span class="n">decay_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">6000.0</span></div>

<span class="k">class</span> <span class="nc">_InverseLRScheduleConfigForKFACwithAdam</span><span class="p">(</span><span class="n">InverseLRScheduleConfig</span><span class="p">):</span>
    <span class="n">decay_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1000</span>


<div class="viewcode-block" id="StandardOptimizerConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.StandardOptimizerConfig">[docs]</a><span class="k">class</span> <span class="nc">StandardOptimizerConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span> <span class="s2">&quot;rmsprop_momentum&quot;</span><span class="p">,</span> <span class="s2">&quot;sgd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;adam&quot;</span>  <span class="c1"># add others optimizers that don&#39;t need further configs here</span>

    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span>

    <span class="n">lr_schedule</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">InverseLRScheduleConfig</span><span class="p">,</span> <span class="n">ConstantLRSchedule</span><span class="p">]</span> <span class="o">=</span> <span class="n">InverseLRScheduleConfig</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Schedule for the learning rate decay&quot;&quot;&quot;</span>

    <span class="n">scaled_modules</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;List of parameters for which the learning rate is being scaled.&quot;&quot;&quot;</span>

    <span class="n">scale_lr</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="sd">&quot;&quot;&quot;Factor which to apply to the learning rates of specified modules&quot;&quot;&quot;</span></div>

<span class="k">class</span> <span class="nc">_OptimizerConfigAdamForPretraining</span><span class="p">(</span><span class="n">StandardOptimizerConfig</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;adam&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;adam&quot;</span>
    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3e-4</span>
    <span class="n">lr_schedule</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ConstantLRSchedule</span><span class="p">,</span> <span class="n">InverseLRScheduleConfig</span><span class="p">]</span> <span class="o">=</span> <span class="n">ConstantLRSchedule</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">_OptimizerConfigSGD</span><span class="p">(</span><span class="n">StandardOptimizerConfig</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span> <span class="s2">&quot;rmsprop_momentum&quot;</span><span class="p">,</span> <span class="s2">&quot;sgd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;sgd&quot;</span>
    <span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">lr_schedule</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">InverseLRScheduleConfig</span><span class="p">,</span> <span class="n">ConstantLRSchedule</span><span class="p">]</span> <span class="o">=</span> <span class="n">ConstantLRSchedule</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">_OptimizerConfigAdamForKFAC</span><span class="p">(</span><span class="n">StandardOptimizerConfig</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span> <span class="s2">&quot;rmsprop_momentum&quot;</span><span class="p">,</span> <span class="s2">&quot;sgd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;adam&quot;</span>
    <span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">2e-3</span>
    <span class="n">lr_schedule</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_InverseLRScheduleConfigForKFACwithAdam</span><span class="p">,</span> <span class="n">InverseLRScheduleConfig</span><span class="p">,</span> <span class="n">ConstantLRSchedule</span><span class="p">]</span> <span class="o">=</span> <span class="n">_InverseLRScheduleConfigForKFACwithAdam</span><span class="p">()</span>


<div class="viewcode-block" id="OptimizerConfigKFAC"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.OptimizerConfigKFAC">[docs]</a><span class="k">class</span> <span class="nc">OptimizerConfigKFAC</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;kfac&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;kfac&quot;</span>
    <span class="sd">&quot;&quot;&quot;Identifier. Fixed&quot;&quot;&quot;</span>

    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="n">lr_schedule</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">InverseLRScheduleConfig</span><span class="p">,</span> <span class="n">ConstantLRSchedule</span><span class="p">]</span> <span class="o">=</span> <span class="n">InverseLRScheduleConfig</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Schedule for the learning rate decay&quot;&quot;&quot;</span>

    <span class="n">momentum</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">norm_constraint</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span>
    <span class="n">damping</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span>
    <span class="n">damping_scheduler</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">estimation_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;fisher_gradients&#39;</span><span class="p">,</span> <span class="s1">&#39;fisher_exact&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fisher_exact&#39;</span>
    <span class="n">register_generic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">update_inverse_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="sd">&quot;&quot;&quot;Period of how often the fisher matrix is being updated (in batches). e.g. update_inverse_period==1 means that it is updated after every gradient step.&quot;&quot;&quot;</span>

    <span class="n">n_burn_in</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">min_damping</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-4</span>
    <span class="n">curvature_ema</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span>
    <span class="n">internal_optimizer</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_OptimizerConfigSGD</span><span class="p">,</span> <span class="n">StandardOptimizerConfig</span><span class="p">]</span> <span class="o">=</span> <span class="n">_OptimizerConfigSGD</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Internal optimizer to use for applying the preconditioned gradients calculated by KFAC. Use SGD for &#39;pure&#39; KFAC.&quot;&quot;&quot;</span></div>


<span class="k">class</span> <span class="nc">_OptimizerConfigKFACwithAdam</span><span class="p">(</span><span class="n">OptimizerConfigKFAC</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;kfac_adam&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;kfac_adam&quot;</span>
    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">norm_constraint</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">6e-5</span>
    <span class="n">lr_schedule</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_InverseLRScheduleConfigForKFACwithAdam</span><span class="p">,</span> <span class="n">InverseLRScheduleConfig</span><span class="p">,</span> <span class="n">ConstantLRSchedule</span><span class="p">]</span> <span class="o">=</span> <span class="n">_InverseLRScheduleConfigForKFACwithAdam</span><span class="p">()</span>
    <span class="n">internal_optimizer</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_OptimizerConfigAdamForKFAC</span><span class="p">,</span> <span class="n">StandardOptimizerConfig</span><span class="p">]</span> <span class="o">=</span> <span class="n">_OptimizerConfigAdamForKFAC</span><span class="p">()</span>


<div class="viewcode-block" id="BFGSOptimizerConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.BFGSOptimizerConfig">[docs]</a><span class="k">class</span> <span class="nc">BFGSOptimizerConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;slbfgs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;slbfgs&quot;</span>
    <span class="sd">&quot;&quot;&quot;Identifier of optimizer. Fixed.&quot;&quot;&quot;</span>

    <span class="n">internal_optimizer</span><span class="p">:</span> <span class="n">StandardOptimizerConfig</span> <span class="o">=</span> <span class="n">StandardOptimizerConfig</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Configuration for built-in optimizer to update the parameters, usinge the preconditioned gradients calculated by BFGS. </span>
<span class="sd">    Use these internal optimizers to easily implement features like momentum.&quot;&quot;&quot;</span>

    <span class="n">memory_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span>
    <span class="sd">&quot;&quot;&quot;Number of gradients to keep in memory to build-up the hessian. Longer memory yields a higher-rank hessian, potentially increasing accuracy, but also slightly increases run-time cost.&quot;&quot;&quot;</span>

    <span class="n">hessian_regularization</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">100.0</span>
    <span class="sd">&quot;&quot;&quot;Amount of Tikhonov regularization to apply&quot;&quot;&quot;</span>

    <span class="n">norm_constraint</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5e-4</span>
    <span class="sd">&quot;&quot;&quot;Maximum of the norm of the preconditioned gradients. If the norm of the preconditioned gradients exceeds this norm_constraint, it will be scaled down to meet this norm.&quot;&quot;&quot;</span>

    <span class="n">use_variance_reduction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;Recalculate 2 batches at the end of each epoch to reduce stochastic MCMC noise in the gradients. Improves accuracy at the expense of 2 additional batches per epoch&quot;&quot;&quot;</span>

    <span class="n">update_hessian_every_n_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="sd">&quot;&quot;&quot;How often to update the hessian. More frequent update (= smaller setting) is preferrable, but can be expensive when using use_variance_reduction=True&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="IntermediateEvaluationConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.IntermediateEvaluationConfig">[docs]</a><span class="k">class</span> <span class="nc">IntermediateEvaluationConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">n_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span>
    <span class="sd">&quot;&quot;&quot;How many evaluation epochs to use for intermediate evaluation.&quot;&quot;&quot;</span>

    <span class="n">opt_epochs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="sd">&quot;&quot;&quot;List of epochs at which to run an intermediate evaluation to accurately assess wavefunction accuracy.&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="SharedOptimizationConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.SharedOptimizationConfig">[docs]</a><span class="k">class</span> <span class="nc">SharedOptimizationConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">use</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">shared_modules</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;What modules/ parts of the neural network should be shared during weight-sharing&quot;&quot;&quot;</span>

    <span class="n">scheduling_method</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;round_robin&quot;</span><span class="p">,</span> <span class="s2">&quot;stddev&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;round_robin&quot;</span>
    <span class="sd">&quot;&quot;&quot;Method to vary between geometries during weight-sharing&quot;&quot;&quot;</span>

    <span class="n">max_age</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="sd">&quot;&quot;&quot;Maximal number of epochs a geometry can be not considered during weight-sharing. Preventing a few geometries from requiring all parameter updates for stddev scheduling&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="CheckpointConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.CheckpointConfig">[docs]</a><span class="k">class</span> <span class="nc">CheckpointConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">replace_every_n_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">keep_every_n_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50_000</span>
    <span class="n">additional_n_epochs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="OptimizationConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.OptimizationConfig">[docs]</a><span class="k">class</span> <span class="nc">OptimizationConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">mcmc</span><span class="p">:</span> <span class="n">MCMCConfigOptimization</span> <span class="o">=</span> <span class="n">MCMCConfigOptimization</span><span class="p">()</span>

    <span class="n">optimizer</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">OptimizerConfigKFAC</span><span class="p">,</span> <span class="n">_OptimizerConfigKFACwithAdam</span><span class="p">,</span> <span class="n">StandardOptimizerConfig</span><span class="p">,</span> <span class="n">BFGSOptimizerConfig</span><span class="p">]</span> <span class="o">=</span> <span class="n">OptimizerConfigKFAC</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Which optimizer to use and its corresponding sub-options&quot;&quot;&quot;</span>

    <span class="n">n_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60_000</span>
    <span class="sd">&quot;&quot;&quot;Number of epochs for wavefunction optimization&quot;&quot;&quot;</span>

    <span class="n">n_epochs_prev</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># if run is restart, this can be used to store number of previous epochs</span>
    <span class="sd">&quot;&quot;&quot;Nr of epochs that this wavefunction has already been optimized. This can be used to store number of previous epochs after a restart&quot;&quot;&quot;</span>

    <span class="n">use_batch_reweighting</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;Reweight gradients for different samples with the changes in log(psi^2) between batches&quot;&quot;&quot;</span>

    <span class="n">checkpoints</span><span class="p">:</span> <span class="n">CheckpointConfig</span> <span class="o">=</span> <span class="n">CheckpointConfig</span><span class="p">()</span>

    <span class="c1"># checkpoints: List[int] = []</span>
    <span class="c1"># &quot;&quot;&quot;List of epoch-numbers at which a checkpoint-file should be dumped, containing all model weights and MCMC-walkers to allow a restart or evaluation&quot;&quot;&quot;</span>

    <span class="n">clipping</span><span class="p">:</span> <span class="n">ClippingConfig</span> <span class="o">=</span> <span class="n">ClippingConfig</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Config for clipping the local energies in the loss function. Clipping significantly improves optimization stability.&quot;&quot;&quot;</span>

    <span class="n">intermediate_eval</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IntermediateEvaluationConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Config for running intermediate evaluation runs during wavefunction optimization to obtain accurate estimates of current accuracy&quot;&quot;&quot;</span>

    <span class="n">shared_optimization</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SharedOptimizationConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Config for shared optimization of multiple wavefunctions using weight-sharing between them&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_epochs_total</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_epochs_prev</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_epochs</span></div>

    <span class="c1"># @root_validator</span>
    <span class="c1"># def scale_lr_for_shared_modules(cls, values):</span>
    <span class="c1">#     if values[&#39;shared_optimization&#39;] is None:</span>
    <span class="c1">#         return values</span>
    <span class="c1">#     shared_modules = values[&#39;shared_optimization&#39;].shared_modules</span>
    <span class="c1">#     optimizer = values[&#39;optimizer&#39;]</span>
    <span class="c1">#</span>
    <span class="c1">#     if isinstance(optimizer, AdamScaledOptimizerConfig):</span>
    <span class="c1">#         if optimizer.scaled_modules is None:</span>
    <span class="c1">#             optimizer.scaled_modules = shared_modules</span>
    <span class="c1">#     if hasattr(optimizer, &#39;internal_optimizer&#39;):</span>
    <span class="c1">#         internal_optimizer = optimizer.internal_optimizer</span>
    <span class="c1">#         if isinstance(internal_optimizer, AdamScaledOptimizerConfig):</span>
    <span class="c1">#             if internal_optimizer.scaled_modules is None:</span>
    <span class="c1">#                 internal_optimizer.scaled_modules = shared_modules</span>
    <span class="c1">#     return values</span>


<div class="viewcode-block" id="RestartConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.RestartConfig">[docs]</a><span class="k">class</span> <span class="nc">RestartConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;restart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;restart&quot;</span>

    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="sd">&quot;&quot;&quot;Path to a previous calculation directory, containing a results.bz2 file&quot;&quot;&quot;</span>

    <span class="n">reuse_config</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;Whether to re-use the configuration of the original run or whether to start from a new default config&quot;&quot;&quot;</span>

    <span class="n">reuse_opt_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;Reuse state of the optimizer, e.g. momentum, hessian estimates&quot;&quot;&quot;</span>

    <span class="n">reuse_mcmc_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;Whether to re-use the position of MCMC walkers. This may only make sense when calculating a wavefunction for the same (or very similar) geometry&quot;&quot;&quot;</span>

    <span class="n">randomize_mcmc_rng</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;Whether to change the state of the random-number-generator of the MCMC state. Does not move walkers, but will change their future random walk&quot;&quot;&quot;</span>

    <span class="n">reuse_clipping_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;Whehter to re-use the clipping state for optimization to clip local energy. This may only make sense when calculating a wavefunction for the same (or very similar) geometry&quot;&quot;&quot;</span>

    <span class="n">reuse_trainable_params</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;Whether to re-use the trainable weights of the neural networks. Use *reuse_modules* to specify only specific parts of the model to be re-used.&quot;&quot;&quot;</span>

    <span class="n">reuse_fixed_params</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;Whether to re-use fixed (i.e. non-trainable) params&quot;&quot;&quot;</span>

    <span class="n">reuse_modules</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Model-specific list of strings, detailing which submodules should be re-used vs. re-initialized randomly. Names of modules to re-used is the same as the list of modules for weight-sharing-constraints.&quot;&quot;&quot;</span>

    <span class="n">continue_n_epochs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;Whether to increment n_epochs_prev in the config, to keep track of total epochs trained&quot;&quot;&quot;</span>

    <span class="n">skip_burn_in</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;Whether to skip burn-in steps for MCMC walkers&quot;&quot;&quot;</span>

    <span class="n">skip_pretraining</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;Whether to skip supervised pretraining of the wavefunction using HartreeFock&quot;&quot;&quot;</span>

    <span class="n">ignore_extra_settings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;Whether to ignore extra config flags that are no longer compatible with the current config&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="ReuseConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.ReuseConfig">[docs]</a><span class="k">class</span> <span class="nc">ReuseConfig</span><span class="p">(</span><span class="n">RestartConfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Do not introduce new fields here&quot;&quot;&quot;</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;reuse&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;reuse&quot;</span>

    <span class="n">reuse_config</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">reuse_opt_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">reuse_mcmc_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">reuse_clipping_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">reuse_trainable_params</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">reuse_fixed_params</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">reuse_modules</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">continue_n_epochs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">skip_burn_in</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">skip_pretraining</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ignore_extra_settings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="ForceEvaluationConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.ForceEvaluationConfig">[docs]</a><span class="k">class</span> <span class="nc">ForceEvaluationConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">use</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">R_cut</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">R_core</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">use_antithetic_sampling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="EvaluationConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.EvaluationConfig">[docs]</a><span class="k">class</span> <span class="nc">EvaluationConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">mcmc</span><span class="p">:</span> <span class="n">MCMCConfigEvaluation</span> <span class="o">=</span> <span class="n">MCMCConfigEvaluation</span><span class="p">()</span>
    <span class="n">n_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10_000</span>
    <span class="n">calculate_energies</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">forces</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ForceEvaluationConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="PhysicalConfigChange"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.PhysicalConfigChange">[docs]</a><span class="k">class</span> <span class="nc">PhysicalConfigChange</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">R</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">E_ref</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">comment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="PhysicalConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.PhysicalConfig">[docs]</a><span class="k">class</span> <span class="nc">PhysicalConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
<div class="viewcode-block" id="PhysicalConfig.get_basic_params"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.PhysicalConfig.get_basic_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_basic_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_electrons</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_up</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_spin_from_hunds_rule</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>
        <span class="n">n_orbitals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>  <span class="c1"># 1s, 2s, 2p, 3s, 3p, 4s, 5d, ...</span>
        <span class="n">n_electrons</span> <span class="o">=</span> <span class="n">Z</span>
        <span class="n">n_up</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_dn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">n_in_orb</span> <span class="ow">in</span> <span class="n">n_orbitals</span><span class="p">:</span>
            <span class="n">n_up</span> <span class="o">+=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_in_orb</span><span class="p">,</span> <span class="n">n_electrons</span><span class="p">)</span>
            <span class="n">n_electrons</span> <span class="o">-=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_in_orb</span><span class="p">,</span> <span class="n">n_electrons</span><span class="p">)</span>
            <span class="n">n_dn</span> <span class="o">+=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_in_orb</span><span class="p">,</span> <span class="n">n_electrons</span><span class="p">)</span>
            <span class="n">n_electrons</span> <span class="o">-=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_in_orb</span><span class="p">,</span> <span class="n">n_electrons</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n_electrons</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">n_up</span> <span class="o">-</span> <span class="n">n_dn</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_generate_el_ion_mapping</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">n_el</span><span class="p">,</span> <span class="n">n_up</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates a list of electrons each mapped to one of the ions.</span>

<span class="sd">        Electrons are mapped, such that local spin is minimzed, by greedily looking for the most unbalanced position</span>
<span class="sd">        and placing and opposite spin electron on this site. Local spin is calculated as a weighted sum of all other ions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="n">n_ions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">R</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dist</span><span class="p">)</span>
        <span class="n">n_per_ion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_ions</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
        <span class="n">n_per_spin</span> <span class="o">=</span> <span class="p">[</span><span class="n">n_up</span><span class="p">,</span> <span class="n">n_el</span> <span class="o">-</span> <span class="n">n_up</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_el</span><span class="p">):</span>
            <span class="c1"># Calculate the spin of each ion (up - down) and calculate a weighted &#39;local&#39; from these raw spins</span>
            <span class="n">local_spin</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">@</span> <span class="p">(</span><span class="n">n_per_ion</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">n_per_ion</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">spin_to_assign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_ions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_ions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)])</span>
            <span class="n">ion_to_assign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_ions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_ions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)])</span>
            <span class="n">resulting_local_spins</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">ind_ion</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spin_to_assign</span><span class="p">,</span> <span class="n">ion_to_assign</span><span class="p">):</span>
                <span class="n">change_in_spin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_ions</span><span class="p">)</span>
                <span class="n">change_in_spin</span><span class="p">[</span><span class="n">ind_ion</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">resulting_local_spins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_spin</span> <span class="o">+</span> <span class="n">weights</span> <span class="o">@</span> <span class="n">change_in_spin</span><span class="p">)</span>

            <span class="c1"># Sort them to find the most unbalanced ions</span>
            <span class="n">ind_additon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">resulting_local_spins</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind_additon</span><span class="p">:</span>
                <span class="n">spin</span> <span class="o">=</span> <span class="n">spin_to_assign</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">ind_ion</span> <span class="o">=</span> <span class="n">ion_to_assign</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">n_per_ion</span><span class="p">[</span><span class="n">ind_ion</span><span class="p">])</span> <span class="o">==</span> <span class="n">Z</span><span class="p">[</span><span class="n">ind_ion</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">n_per_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="c1"># Do not put more electrons of this spin if there are no more electrons left or the atom is full</span>
                    <span class="k">continue</span>
                <span class="n">n_per_ion</span><span class="p">[</span><span class="n">ind_ion</span><span class="p">,</span> <span class="n">spin</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">n_per_spin</span><span class="p">[</span><span class="n">spin</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">break</span>

        <span class="c1"># Convert to list of length electrons</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ind_ion</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">n_per_ion</span><span class="p">[:,</span> <span class="n">spin</span><span class="p">]):</span>
                <span class="n">mapping</span> <span class="o">=</span> <span class="n">mapping</span> <span class="o">+</span> <span class="p">[</span><span class="n">ind_ion</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>
        <span class="k">return</span> <span class="n">mapping</span>

    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Name of the molecule to be calculated. If other physical parameters are not specified, this name will be used as a lookup-key to find default values.&quot;&quot;&quot;</span>

    <span class="n">R</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;List of lists, specifiying the position of all ions. Outer index loops over ions, inder index loops over 3 coordinates XYZ.&quot;&quot;&quot;</span>

    <span class="n">Z</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Nuclear charges per ion&quot;&quot;&quot;</span>

    <span class="n">n_electrons</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Total number of electrons in the system&quot;&quot;&quot;</span>

    <span class="n">n_up</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Number of spin-up electrons&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_dn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_electrons</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_up</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_ions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>

    <span class="n">el_ion_mapping</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Initial position of electrons. len(el_ion_mapping) == n_electrons. For each electron the list-entry specifies the index of the nucleus where the electron should be initialized.</span>
<span class="sd">    Note that the n_up first entries in this list correpsond to spin-up electrons and the remaining entries correspond to spin-down electrons&quot;&quot;&quot;</span>

    <span class="n">n_cas_electrons</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Number of active electrons to include in the CASSCF calculation. Other electrons will be kept fixed in their respective orbitals.&quot;&quot;&quot;</span>

    <span class="n">n_cas_orbitals</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Number of active orbitals to include in the CASSCF calculation. Other orbitals are kept as always occupied or always unoccupied, depending on their energy.&quot;&quot;&quot;</span>

    <span class="n">E_ref</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Known ground-truth energy as reference for output. This value is not used in the actual calculation, but only to benchmark the achieved results.&quot;&quot;&quot;</span>

    <span class="n">E_ref_source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Source of included reference energy&quot;&quot;&quot;</span>

    <span class="n">comment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Optional comment to keep track of molecules, geometries or experiments&quot;&quot;&quot;</span>
    
    <span class="n">changes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">PhysicalConfigChange</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;List of changes to be made to this physical-configuration to obtain different molecules. This can be used to calculate multiple geometries with similar settings, by specifying a base configuration (e.g. charge, spin, CASSCF-settings, etc) and only specifying the changes (e.g. in nuclear geometry) in the changes section.&quot;&quot;&quot;</span>

    <span class="n">_PERIODIC_TABLE</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
        <span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;He&#39;</span><span class="p">,</span> <span class="s1">&#39;Li&#39;</span><span class="p">,</span> <span class="s1">&#39;Be&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;Ne&#39;</span><span class="p">,</span> <span class="s1">&#39;Na&#39;</span><span class="p">,</span> <span class="s1">&#39;Mg&#39;</span><span class="p">,</span> <span class="s1">&#39;Al&#39;</span><span class="p">,</span> <span class="s1">&#39;Si&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span>
         <span class="s1">&#39;Cl&#39;</span><span class="p">,</span> <span class="s1">&#39;Ar&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;Ca&#39;</span><span class="p">,</span> <span class="s1">&#39;Sc&#39;</span><span class="p">,</span> <span class="s1">&#39;Ti&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;Cr&#39;</span><span class="p">,</span> <span class="s1">&#39;Mn&#39;</span><span class="p">,</span> <span class="s1">&#39;Fe&#39;</span><span class="p">,</span> <span class="s1">&#39;Co&#39;</span><span class="p">,</span> <span class="s1">&#39;Ni&#39;</span><span class="p">,</span> <span class="s1">&#39;Cu&#39;</span><span class="p">,</span> <span class="s1">&#39;Zn&#39;</span><span class="p">,</span> <span class="s1">&#39;Ga&#39;</span><span class="p">,</span> <span class="s1">&#39;Ge&#39;</span><span class="p">,</span> <span class="s1">&#39;As&#39;</span><span class="p">,</span> <span class="s1">&#39;Se&#39;</span><span class="p">,</span> <span class="s1">&#39;Br&#39;</span><span class="p">,</span> <span class="s1">&#39;Kr&#39;</span><span class="p">])}</span>

    <span class="n">_DEFAULT_MOLECULES</span> <span class="o">=</span> <span class="n">ruamel</span><span class="o">.</span><span class="n">yaml</span><span class="o">.</span><span class="n">YAML</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;molecules.yaml&#39;</span><span class="p">))</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">populate_R</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_PERIODIC_TABLE</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_MOLECULES</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]][</span><span class="s1">&#39;R&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">populate_Z</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Z</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_PERIODIC_TABLE</span><span class="p">:</span>
                <span class="n">Z</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_PERIODIC_TABLE</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Z</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_MOLECULES</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]][</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;List of nuclear charges Z has length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span><span class="si">}</span><span class="s2">, but list of ion positions R has length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Z</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;n_electrons&quot;</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">populate_n_electrons</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_MOLECULES</span><span class="p">:</span>
                <span class="n">charge</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_MOLECULES</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;charge&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">charge</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">n_electrons</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">charge</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">n_electrons</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;n_up&quot;</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">populate_n_up</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_PERIODIC_TABLE</span><span class="p">:</span>
                <span class="n">spin</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_spin_from_hunds_rule</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_MOLECULES</span><span class="p">):</span>
                <span class="n">spin</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_MOLECULES</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;spin&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">spin</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;n_electrons&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">spin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>  <span class="c1"># if there is an extra electrons, assign them to up</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;el_ion_mapping&quot;</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">populate_el_ion_mapping</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_MOLECULES</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;el_ion_mapping&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_MOLECULES</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_MOLECULES</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]][</span><span class="s1">&#39;el_ion_mapping&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_generate_el_ion_mapping</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;n_electrons&#39;</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;n_up&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;n_electrons&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;An initial ion-mapping must be supplied for all electrons. len(el_ion_mapping)=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">, n_electrons=</span><span class="si">{</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;n_electrons&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;n_cas_electrons&quot;</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">populate_n_cas_electrons</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_MOLECULES</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_MOLECULES</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cas_n_active_electrons&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;n_cas_orbitals&quot;</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">populate_n_cas_orbitals</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_MOLECULES</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_MOLECULES</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cas_n_active_orbitals&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;E_ref&quot;</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">populate_E_ref</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_MOLECULES</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_MOLECULES</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;E_ref&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;E_ref_source&quot;</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">populate_E_ref_source</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_MOLECULES</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_MOLECULES</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;E_ref_source&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

<div class="viewcode-block" id="PhysicalConfig.set_from_changes"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.PhysicalConfig.set_from_changes">[docs]</a>    <span class="k">def</span> <span class="nf">set_from_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">changes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">change</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">changes</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">PhysicalConfig</span><span class="o">.</span><span class="n">update_configdict_and_validate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span> <span class="n">change</span><span class="o">.</span><span class="n">as_flattened_dict</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">p</span><span class="o">.</span><span class="n">changes</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div></div>


<div class="viewcode-block" id="LoggerBaseConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.LoggerBaseConfig">[docs]</a><span class="k">class</span> <span class="nc">LoggerBaseConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">n_skip_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="WandBConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.WandBConfig">[docs]</a><span class="k">class</span> <span class="nc">WandBConfig</span><span class="p">(</span><span class="n">LoggerBaseConfig</span><span class="p">):</span>
    <span class="n">project</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
    <span class="n">entity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">use_id</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">blacklist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="BasicLoggerConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.BasicLoggerConfig">[docs]</a><span class="k">class</span> <span class="nc">BasicLoggerConfig</span><span class="p">(</span><span class="n">LoggerBaseConfig</span><span class="p">):</span>
    <span class="n">log_to_stdout</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">log_level</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;CRITICAL&quot;</span><span class="p">,</span> <span class="s2">&quot;FATAL&quot;</span><span class="p">,</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">,</span> <span class="s2">&quot;WARN&quot;</span><span class="p">,</span> <span class="s2">&quot;WARNING&quot;</span><span class="p">,</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;DEBUG&quot;</span>
    <span class="n">n_skip_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">fname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;log.out&quot;</span></div>


<div class="viewcode-block" id="PickleLoggerConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.PickleLoggerConfig">[docs]</a><span class="k">class</span> <span class="nc">PickleLoggerConfig</span><span class="p">(</span><span class="n">LoggerBaseConfig</span><span class="p">):</span>
    <span class="n">fname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;results.bz2&#39;</span></div>


<div class="viewcode-block" id="LoggingConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.LoggingConfig">[docs]</a><span class="k">class</span> <span class="nc">LoggingConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="sd">&quot;&quot;&quot;List of tags to help mark/identify runs&quot;&quot;&quot;</span>

    <span class="n">log_opt_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;Flag whether to log the full state of the optimizer. Note that this can produce very large output-files, in particular when logging the hessian of 2nd-order-optimizers&quot;&quot;&quot;</span>

    <span class="n">basic</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BasicLoggerConfig</span><span class="p">]</span> <span class="o">=</span> <span class="n">BasicLoggerConfig</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Config for basic logger, which will produce human-readable log-files using the python built-in logging module&quot;&quot;&quot;</span>

    <span class="n">wandb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">WandBConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Config for logging to Weights&amp;Biases&quot;&quot;&quot;</span>

    <span class="n">pickle</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PickleLoggerConfig</span><span class="p">]</span> <span class="o">=</span> <span class="n">PickleLoggerConfig</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Config for logging to binary files, which contain machine-readable pickle files containg all configs, metrics and model weights&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="DispatchConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.DispatchConfig">[docs]</a><span class="k">class</span> <span class="nc">DispatchConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">system</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="s2">&quot;local_background&quot;</span><span class="p">,</span> <span class="s2">&quot;vsc3&quot;</span><span class="p">,</span> <span class="s2">&quot;vsc4&quot;</span><span class="p">,</span> <span class="s2">&quot;dgx&quot;</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
    <span class="sd">&quot;&quot;&quot;Which compute-cluster to use for this experiment. &#39;auto&#39; detects whether the code is running on a known compute-cluster and selects the corresponding profile, or otherwise defaults to local execution&quot;&quot;&quot;</span>

    <span class="n">queue</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span>
        <span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="s2">&quot;vsc3plus_0064&quot;</span><span class="p">,</span> <span class="s2">&quot;devel_0128&quot;</span><span class="p">,</span> <span class="s2">&quot;gpu_a40dual&quot;</span><span class="p">,</span> <span class="s2">&quot;gpu_gtx1080amd&quot;</span><span class="p">,</span> <span class="s2">&quot;gpu_gtx1080multi&quot;</span><span class="p">,</span> <span class="s2">&quot;gpu_gtx1080single&quot;</span><span class="p">,</span> <span class="s2">&quot;gpu_v100&quot;</span><span class="p">,</span> <span class="s2">&quot;gpu_k20m&quot;</span><span class="p">,</span> <span class="s2">&quot;gpu_rtx2080ti&quot;</span><span class="p">,</span> <span class="s2">&quot;jupyter&quot;</span><span class="p">,</span> <span class="s2">&quot;normal_binf&quot;</span><span class="p">,</span> <span class="s2">&quot;vsc3plus_0256&quot;</span><span class="p">,</span> <span class="s2">&quot;mem_0096&quot;</span><span class="p">,</span> <span class="s2">&quot;devel_0096&quot;</span><span class="p">,</span> <span class="s2">&quot;jupyter&quot;</span><span class="p">,</span> <span class="s2">&quot;mem_0096&quot;</span><span class="p">,</span> <span class="s2">&quot;mem_0384&quot;</span><span class="p">,</span> <span class="s2">&quot;mem_0768&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
    <span class="sd">&quot;&quot;&quot;SLURM queue to use for job submission on compute clusters. Not relevant for local execution&quot;&quot;&quot;</span>

    <span class="n">time</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;3day&quot;</span>
    <span class="sd">&quot;&quot;&quot;Maximum job run-time to use for job submission on compute clusters. Not relevant for local execution&quot;&quot;&quot;</span>

    <span class="n">conda_env</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;jax&quot;</span>
    <span class="sd">&quot;&quot;&quot;Conda environment to select in SLURM-job-script. Not relevant for local execution&quot;&quot;&quot;</span>

    <span class="n">split_opt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">eval_epochs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="ComputationConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.ComputationConfig">[docs]</a><span class="k">class</span> <span class="nc">ComputationConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">use_gpu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;deprecated&quot;&quot;&quot;</span>
    <span class="n">require_gpu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">n_devices</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">force_device_count</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">disable_jit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">float_precision</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="s2">&quot;float64&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;float32&quot;</span>
    <span class="n">disable_tensor_cores</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">use_profiler</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="PreTrainingConfig"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.PreTrainingConfig">[docs]</a><span class="k">class</span> <span class="nc">PreTrainingConfig</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="n">use</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">mcmc</span><span class="p">:</span> <span class="n">MCMCConfigPreTrain</span> <span class="o">=</span> <span class="n">MCMCConfigPreTrain</span><span class="p">()</span>

    <span class="n">n_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="sd">&quot;&quot;&quot;Number of pre-training steps to fit DL-wavefunction to a baseline calculation as e.g. Hartree Fock&quot;&quot;&quot;</span>

    <span class="n">optimizer</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_OptimizerConfigAdamForPretraining</span><span class="p">,</span> <span class="n">StandardOptimizerConfig</span><span class="p">]</span> <span class="o">=</span> <span class="n">_OptimizerConfigAdamForPretraining</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Optimizer used for pre-training only. Setting will not affect standard optimization&quot;&quot;&quot;</span>

    <span class="n">use_only_leading_determinant</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;Whether to use only Hartree Fock determinant for pre-training or for each DL-wavefunction determinant a different CAS determinant&quot;&quot;&quot;</span>

    <span class="n">baseline</span><span class="p">:</span> <span class="n">CASSCFConfig</span> <span class="o">=</span> <span class="n">CASSCFConfig</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Physical baseline settings for pre-training&quot;&quot;&quot;</span></div>

<span class="c1"># TODO: Generate a simple overview graphics of the main config options; use the schema to autogenerate?</span>
<div class="viewcode-block" id="Configuration"><a class="viewcode-back" href="../../configuration.html#deeperwin.configuration.Configuration">[docs]</a><span class="k">class</span> <span class="nc">Configuration</span><span class="p">(</span><span class="n">ConfigBaseclass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Root configuration for DeepErwin&quot;&quot;&quot;</span>

    <span class="n">physical</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PhysicalConfig</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;The physical system/molecule being calculated&quot;&quot;&quot;</span>

    <span class="n">pre_training</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PreTrainingConfig</span><span class="p">]</span> <span class="o">=</span> <span class="n">PreTrainingConfig</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Supervised pre-training of the orbitals to fit the baseline orbitals.&quot;&quot;&quot;</span>

    <span class="n">optimization</span><span class="p">:</span> <span class="n">OptimizationConfig</span> <span class="o">=</span> <span class="n">OptimizationConfig</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;The wavefunction optimization&quot;&quot;&quot;</span>

    <span class="n">evaluation</span><span class="p">:</span> <span class="n">EvaluationConfig</span> <span class="o">=</span> <span class="n">EvaluationConfig</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;The evaluation of the wavefunction (after optimization)&quot;&quot;&quot;</span>

    <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ModelConfigDeepErwin4</span><span class="p">,</span> <span class="n">ModelConfigFermiNet</span><span class="p">,</span> <span class="n">ModelConfigDeepErwin1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ModelConfigDeepErwin4</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;The actual wavefunction model mapping electron coordinates to psi&quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="p">:</span> <span class="n">LoggingConfig</span> <span class="o">=</span> <span class="n">LoggingConfig</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;The output of the code, e.g. logging to files, or online-services&quot;&quot;&quot;</span>

    <span class="n">computation</span><span class="p">:</span> <span class="n">ComputationConfig</span> <span class="o">=</span> <span class="n">ComputationConfig</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Options regarding computational details such as GPU usage and float precision&quot;&quot;&quot;</span>

    <span class="n">dispatch</span><span class="p">:</span> <span class="n">DispatchConfig</span> <span class="o">=</span> <span class="n">DispatchConfig</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Options regarding where the code is being run, i.e. locally vs asynchronysly on a compute-cluster&quot;&quot;&quot;</span>

    <span class="n">reuse</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">RestartConfig</span><span class="p">,</span> <span class="n">ReuseConfig</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Reuse information from a previosu runt to smartly initialize weights or MCMC walkers.&quot;&quot;&quot;</span>

    <span class="n">comment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Optional coment to keep track of experiments&quot;&quot;&quot;</span>

    <span class="n">experiment_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;deeperwin_experiment&quot;</span>
    <span class="sd">&quot;&quot;&quot;Experiment name to keep track of experiments&quot;&quot;&quot;</span>

    <span class="nd">@root_validator</span>
    <span class="k">def</span> <span class="nf">experiment_has_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;experiment_name&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;physical&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;experiment_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;exp&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;experiment_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;physical&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="n">values</span>

    <span class="nd">@root_validator</span>
    <span class="k">def</span> <span class="nf">no_reuse_while_shared</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;optimization&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shared_optimization</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;reuse&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Re-using weights not currently supported for shared optimization&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span></div>


<div class="viewcode-block" id="get_with_flattened_key"><a class="viewcode-back" href="../../_autosummary/deeperwin.configuration.get_with_flattened_key.html#deeperwin.configuration.get_with_flattened_key">[docs]</a><span class="k">def</span> <span class="nf">get_with_flattened_key</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">parent_key</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">child_key</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">get_with_flattened_key</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">parent_key</span><span class="p">),</span> <span class="n">child_key</span><span class="p">)</span></div>

<div class="viewcode-block" id="set_with_flattened_key"><a class="viewcode-back" href="../../_autosummary/deeperwin.configuration.set_with_flattened_key.html#deeperwin.configuration.set_with_flattened_key">[docs]</a><span class="k">def</span> <span class="nf">set_with_flattened_key</span><span class="p">(</span><span class="n">config_dict</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
        <span class="n">config_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config_dict</span> <span class="ow">or</span> <span class="n">config_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key_child</span><span class="p">,</span> <span class="n">value_child</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">set_with_flattened_key</span><span class="p">(</span><span class="n">config_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">key_child</span><span class="p">,</span> <span class="n">value_child</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">parent_key</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">child_key</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">if</span> <span class="n">parent_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">:</span>
            <span class="n">config_dict</span><span class="p">[</span><span class="n">parent_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">set_with_flattened_key</span><span class="p">(</span><span class="n">config_dict</span><span class="p">[</span><span class="n">parent_key</span><span class="p">],</span> <span class="n">child_key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">config_dict</span></div>

<div class="viewcode-block" id="build_nested_dict"><a class="viewcode-back" href="../../_autosummary/deeperwin.configuration.build_nested_dict.html#deeperwin.configuration.build_nested_dict">[docs]</a><span class="k">def</span> <span class="nf">build_nested_dict</span><span class="p">(</span><span class="n">flattened_dict</span><span class="p">):</span>
    <span class="n">root_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">flattened_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">key_tokens</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">root_dict</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">key_tokens</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_tokens</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>  <span class="c1"># reached leaf =&gt; store value</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="c1"># traverse further</span>
    <span class="k">return</span> <span class="n">root_dict</span></div>

<div class="viewcode-block" id="build_flattend_dict"><a class="viewcode-back" href="../../_autosummary/deeperwin.configuration.build_flattend_dict.html#deeperwin.configuration.build_flattend_dict">[docs]</a><span class="k">def</span> <span class="nf">build_flattend_dict</span><span class="p">(</span><span class="n">nested_dict</span><span class="p">):</span>
    <span class="n">flattened_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">nested_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">flattened_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">build_flattend_dict</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flattened_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">flattened_dict</span></div>


<div class="viewcode-block" id="to_prettified_yaml"><a class="viewcode-back" href="../../_autosummary/deeperwin.configuration.to_prettified_yaml.html#deeperwin.configuration.to_prettified_yaml">[docs]</a><span class="k">def</span> <span class="nf">to_prettified_yaml</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_convert_to_inline_block</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">ruamel</span><span class="o">.</span><span class="n">yaml</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">CommentedSeq</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">fa</span><span class="o">.</span><span class="n">set_flow_style</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">_convert_data</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">_convert_data</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_convert_to_inline_block</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span>

    <span class="k">return</span> <span class="n">_convert_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pathlib</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">parse_obj</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">physical</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;LiH&#39;</span><span class="p">),</span> <span class="n">model</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;dpe4&quot;</span><span class="p">)))</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;../../sample_configs/config_schema.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Updating: &quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">schema_json</span><span class="p">())</span>
    <span class="c1">#</span>
    <span class="c1"># c = Configuration.parse_obj(dict(reuse=dict(mode=&#39;reuse&#39;, reuse_config=False, path=&quot;&quot;)))</span>
    <span class="c1"># print(c.reuse)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Michael Scherbela, Leon Gerard, Rafael Reisenhofer.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>